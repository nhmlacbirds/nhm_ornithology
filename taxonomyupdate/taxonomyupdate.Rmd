---
title: "Untitled"
author: "YS"
date: "2024-02-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(here)
library(tidyverse)
library(readxl)
library(stringi)
```

```{r}
setwd("C:/Users/young/Documents/nhm_ornithology/taxonomyupdate")
here::i_am("taxonomyupdate.Rmd")
here()
```

Load LACM list

```{r}
lacm <- read_excel("lacmtaxonomy.xlsx", col_names = c("catlog", "order", "family", "genus", "species", "subspecies", "rank", "sciname"), skip=1)

#test <- lacm[which(lacm$sciname == "Tyto alba"),]


ltax <- unique(lacm$sciname) #5667; some subspecies don't have a species level entry
ltax2 <- unique(lacm$fullname) #11539 (full list is 124096)


# get list of unique species + add family and order
lacmlist <- lacm[!duplicated(lacm[,"fullname"]),] %>% select(fullname, sciname, subspecies, genus, species, family, order)


#write.csv(lacmlist, "lacm_species_full.csv")
#lacmlist <- read.csv("lacm_species2.csv")


# new value for ssp=NA
lacmlist$subspecies[is.na(lacmlist$subspecies)] <- "NA"

# change ssp value to NA
lacmlist$subspecies[lacmlist$subspecies == "ssp"]  <- "NA" 

# change ssp value
lacmlist$fullname <- gsub("ssp", "NA", lacmlist$fullname)

n_distinct(lacmlist$fullname) #11119 
```


```{r}
translat <- read_excel("peters_clements.xlsx")

translat$ct_pet <- stri_count(translat$peters, regex="\\S+")
translat$ct_clements <- stri_count(translat$clements, regex="\\S+")


## separate genus and species
# separate genus
translat$genus_pet <- sub(" .*", "", translat$peters)

# species needs to go on two turns [learn how to do it in one]
translat$species_pet <- sub(" [^ ]+$|^.*? ", "", translat$peters)
translat$species_pet <- sub(" .*", "", translat$species_pet)

# extract subspecies
translat$ssp_pet <- ifelse(translat$ct_pet == 3, sub(".* ", "", translat$peters), "NA")

# do same for clements
translat$genus_clements <- sub(" .*", "", translat$clements)
translat$species_clements <- sub(" [^ ]+$|^.*? ", "", translat$clements)
translat$species_clements <- sub(" .*", "", translat$species_clements)
translat$ssp_clements <- ifelse(translat$ct_clements == 3, sub(".* ", "", translat$clements), "NA")

# have full name
translat$full_clements <- paste(translat$genus_clements, translat$species_clements, translat$ssp_clements, sep = " ")
translat$full_pet <- paste(translat$genus_pet, translat$species_pet, translat$ssp_pet, sep = " ")

# left join - v1
# upd <- lacmlist %>%  #5667 
#   left_join(translat, by=c("genus" = "genus_pet", "species" = "species_pet")) %>% 
#   distinct(sciname, .keep_all = TRUE)

# left join - v2; better but missing some 
upd0 <- lacmlist %>%
  left_join(translat, by=c("genus" = "genus_pet", "species" = "species_pet", "subspecies" = "ssp_pet")) %>% 
  distinct(fullname, .keep_all = TRUE)

# which ones are missing? 
check <- upd0[is.na(upd0$clements),] #2107

# first, filter those that are already matching the new taxonomy
check2 <- check %>% 
  left_join(translat, by=c("genus" = "genus_clements", "species" = "species_clements", "subspecies" = "ssp_clements"))%>% 
  distinct(fullname, .keep_all = TRUE)


# left join - v3; goes from 11539 to 11119; but that is correct
upd3 <- lacmlist %>% 
  left_join(translat, by=c("fullname" = "full_pet")) %>% distinct(fullname, .keep_all = TRUE)

n_distinct(lacmlist$fullname) #11119 
n_distinct(upd3$fullname) #11119 


# check those missing
check3 <- upd3[is.na(upd3$clements),] #1437 okay, fewer than before but slightly

check_next <- check3 %>% select(fullname, genus, species, subspecies, family, order)

# join with clements name (i.e., emu name matches new clements list)
upd4 <- check_next %>% 
  left_join(translat, by=c("fullname" = "full_clements")) %>% 
  distinct(fullname, .keep_all = T)

# filter NA
check4 <- upd4[is.na(upd4$clements),] #1222 okay, fewer than before but still a lot 

check_next <- check4 %>% select(fullname, genus, species, subspecies, family, order)

write.csv(check_next, "check_taxon.csv")
```


1) remove clements == NA from upd3 and 
merge it with
2) remove clements == NA from upd4 
3) merge everything back
4) do a ifelse match fxn to get final list to Bill 




Next steps
```{r}
###########
# separate genus and species
upd$genus_clements <- sub(" .*", "", upd$clements)
upd$species_clements <- sub(" [^ ]+$|^.*? ", "", upd$clements)
upd$species_clements <- sub(" .*", "", upd$species_clements)


# how to deal with subspecies - noted as subspecies for EMu
upd$spp_clements <- ifelse(upd$io_rank == "ssp", sub(".* ", "", upd$clements), NA)

upd$name_match <- ifelse(upd$clements == upd$peters, "match", "no")
upd$genus_match <- ifelse(upd$genus_clements == upd$genus, "match", "no")
upd$species_match <- ifelse(upd$species_clements == upd$species, "match", "no")


upd2 <- upd %>% 
  mutate(emu_order = order,
         emu_family = family,
         emu_genus = genus,
         emu_species = species,
         emu_subspecies = subspecies,
         new_order = order_clements,
         new_family = family_clements,
         new_genus = genus_clements,
         new_species = species_clements)
  select(IOC_seq, emu_order, emu_family, emu_genus, emu_species, emu_subspecies, new_order, new_family, new_genus, new_species, )
```










# old
Load IOC list for comparison; want to update lacm list to IOC 

```{r}
ioc <- read_excel("taxlists.xlsx")
ioc2 <- ioc %>% 
 filter(rank == "species") #only filter out at species level, not subspecies

iocsub <- ioc[,1:12] #only the first 12 columns

comp <- lacmlist 
```


Seems like some subspecies got split; 
```{r}
new <- lacmlist %>% 
  left_join(mbf_hm_translation, by=c("genus"="Genus_MBF","species"="Species_MBF")) %>% 
  filter(!is.na(ORDER_MBF)) #n=6023
```


Deal with subspecies
```{r}
lacm0 <- lacm %>% filter(subspecies != "ssp")

lacm0$spp <- paste(lacm0$genus, lacm0$species, lacm0$subspecies, sep=" ")

lacmlist0 <- lacm0[!duplicated(lacm0[,"spp"]),] %>% select(spp, sciname, genus, species, family, order) #7634
```

